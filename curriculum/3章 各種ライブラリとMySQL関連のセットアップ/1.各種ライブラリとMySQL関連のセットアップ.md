# 各種ライブラリとMySQL関連のセットアップ

- 本章では掲示板Webアプリの開発に使用する各種ライブラリやデータベース（DB）のインストール、セットアップを行います。

## 1. 各種ライブラリのインストール
- 今回利用する各種ライブラリの一覧は以下になります。

| 分類 | ライブラリ名 | Version |
| ---------- | --- | --- |
| JDBCドライバ | JDBC Driver for MySQL | 8.0.24 |
| O/Rマッパー | Hibernate | 5.6.9.Final |
| JSP カスタムタグ | jstl  | 1.2 |

### 1.1. Mavenについて
- 今回ライブラリ管理には「Maven」を利用します。
- 「Maven」はいわゆる「ビルドツール」、「プロジェクト管理ツール」と呼ばれるソフトウェアになりますが、今回は  
その中の一部「ライブラリ管理」の目的で使用します。
- Mavenを使用することで手動で外部ライブラリをインストールする必要はなく、POM.xml（Project Object Model）とよばれる  
設定ファイルに必要なライブラリを記述することで依存関係を含めたライブラリを自動で取得、配置することができます。

### 1.2. Mavenのセットアップ
- EclipseのプロジェクトでMavenを利用するためには、「Mavenプロジェクト」という形式で作成する必要があります。
- 既に新規プロジェクトを作成した状態ですので、既存のプロジェクトを「Mavenプロジェクトに変換」していきます。
  - 手順：プロジェクトを右クリック＞構成＞Mavenプロジェクトへ変換 をクリックします。
  - 新規POMの作成ウィザードが開きます。デフォルト値でOKです。「完了」をクリックします。  
[![Image from Gyazo](https://i.gyazo.com/8be4e528a3aeec6fcbd94a5411181b4e.png)](https://gyazo.com/8be4e528a3aeec6fcbd94a5411181b4e)
  - POM.xmlというファイルが作成されていることを確認します。  
[![Image from Gyazo](https://i.gyazo.com/eed52e18ca634d1502d2d4575aa4ce19.png)](https://gyazo.com/eed52e18ca634d1502d2d4575aa4ce19)

  - POM.xmlをダブルクリックで開きます。
  - 「依存関係」タブを開き、「追加」をクリックします。  
[![Image from Gyazo](https://i.gyazo.com/e1bb40754708eb5946374f8ea2760d4e.png)](https://gyazo.com/e1bb40754708eb5946374f8ea2760d4e)
  - 以下のように入力し、「OK」をクリックします。  
    - グループID ： mysql
    - アーティファクトID ： mysql-connector-java
    - バージョン ： 8.0.24  
[![Image from Gyazo](https://i.gyazo.com/a5a4cc106d8b2d5be6820b9f840d3035.png)](https://gyazo.com/a5a4cc106d8b2d5be6820b9f840d3035)
    - 以下のような内容で登録できていればOKです。  
[![Image from Gyazo](https://i.gyazo.com/3356b7963a9154d415ffacec00b1124c.png)](https://gyazo.com/3356b7963a9154d415ffacec00b1124c)
- 同様に以下のライブラリも登録していきます。  
- Hibernate:
    - グループID ： org.hibernate
    - アーティファクトID ： hibernate-core
    - バージョン ： 5.6.9.Final  
- JSTL:
    - グループID ： javax.servlet
    - アーティファクトID ： jstl
    - バージョン ： 1.2
- 以下のような内容で登録できていればOKです。  
[![Image from Gyazo](https://i.gyazo.com/4e876d8aa2362b6f5b6b5666407fb668.png)](https://gyazo.com/4e876d8aa2362b6f5b6b5666407fb668)

- ここでプロジェクト一覧のビューを変更しておきたいと思います。筆者は「パッケージ・エクスプローラー」の方が見やすいのでいつもこちらを使用しています。
  - 手順：ウィンドウ＞ビューの表示＞その他＞パッケージ・エクスプローラーを開きます。  
[![Image from Gyazo](https://i.gyazo.com/07d96b298084b03742bde1bc3e32e14b.png)](https://gyazo.com/07d96b298084b03742bde1bc3e32e14b)
  - パッケージ・エクスプローラが開きます。（位置は各自調整してください）
  - プロジェクト＞Maven依存関係と展開していくと、＊＊＊.jarというファイルがたくさんあるのに気づくかと思います。  
  - 外部ライブラリの実態はこの、jarファイル（Java Archive）ファイルと呼ばれるもので、実行形式ファイル（.class）を圧縮形式にしたものです。  
  - 本来はこれらjarファイルを手動でダウンロード、配置しなければいけないのですが、Mavenを利用するとこれらの依存関係ファイルも含めてダウンロード、配置してくれます。  
[![Image from Gyazo](https://i.gyazo.com/b1fc85e1646e1e6a2462081baa8b6e35.png)](https://gyazo.com/b1fc85e1646e1e6a2462081baa8b6e35)

## 2. MySQLのインストール
- 次にMySQLのインストールを行います。
- 今回は執筆時点で最新の8.0系を使用します。
- 手順：以下サイトにアクセスします。
    - https://downloads.mysql.com/archives/community/
    - Product Versionから8.0.xの最新を選択（執筆時点8.0.28）
    - Operating Systemからご自分のOSを選択
[![Image from Gyazo](https://i.gyazo.com/65664666aa43210f0154467673961f5a.png)](https://gyazo.com/65664666aa43210f0154467673961f5a)  
    - Windowsの方であれば、以下「Windows (x86, 64-bit), ZIP Archive」をDownloadしてください。
[![Image from Gyazo](https://i.gyazo.com/9781091dc6565c45b47d81d7c3f27501.png)](https://gyazo.com/9781091dc6565c45b47d81d7c3f27501)  
    - アカウント登録を求める画面が表示されたら、「No thanks, just start my download.」をクリックしてMySQLのダウンロードを開始します。
    - ダウンロード後、ウィザードに従ってインストールを実施してください。
> Note : 今回はJavaの教材のためMySQLのインストール手順詳細は記載していません。特に迷うことなくデフォルト値でインストールを進められると思いますが、必要に応じて「MySQL インストール」などでGoogle検索を行って確認してください。

### 2.1. 掲示板Webアプリ用のデータベースを作成
- ここで掲示板Webアプリ用のデータベースを作成します。
- 手順：ターミナルやコマンドプロンプトからMySQLにrootで接続してください。
``` SQL
$ mysql -u root -p
Enter password: 
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 8
Server version: 8.0.24 MySQL Community Server - GPL

Copyright (c) 2000, 2021, Oracle and/or its affiliates.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

mysql> 
```
- 手順：データベースの作成、接続ユーザの作成、権限の付与を行います。

``` SQL
mysql> create database chatspaceapp default character set utf8;
mysql> create user 'chatspaceuser'@'localhost' identified by 'chatspaceuser';
mysql> grant all privileges on chatspaceapp.* to 'chatspaceuser'@'localhost';
```

- 確認：データベース、接続ユーザが作成されていることを確認します。
``` SQL
mysql> show databases;
+--------------------------+
| Database                 |
+--------------------------+
| chatspaceapp             |

mysql> select user, host from mysql.user;
+------------------+-----------+
| user             | host      |
+------------------+-----------+
| chatspaceuser    | localhost |
```


## 3. Hibernateのセットアップ
- 次にHibernateのセットアップを行います。
- まず、用語「ORマッパー」、「JPA」、「Hibernate」について整理しておきたいと思います。
### 3.1. ORマッパー
- ORマッパーとは、O/Rマッピング (Object / Relational Mapping)をサポートするソフトウェアのことを指します。
- O/RマッピングとはObject（=Java：オブジェクト指向）で扱うデータと、Relational（=MySQL：リレーショナルデータベース）のデータ構造的な差異を埋めるための仕組みのことです。
> Note : O/Rマッピングのイメージ  
- Object（=Java：オブジェクト指向）のデータイメージ
  - ObjectはStructured（階層的）なデータ構造で表されます。
  - 例えば、「Asia」の中の「Japan」の中の「Tokyo」といったイメージです。
[![Image from Gyazo](https://i.gyazo.com/52b39c0718b81c9d597232752636c1a7.png)](https://gyazo.com/52b39c0718b81c9d597232752636c1a7)  

- Relational（=MySQL：リレーショナルデータベース）のデータイメージ
  - 一方、Relationaなデータはいわゆる表形式（列、行）で表されます。Excel等の表計算ソフトをイメージすると分かりやすいかもしれません。  
[![Image from Gyazo](https://i.gyazo.com/9d55a55b93c00fdc488a23818af39b3a.png)](https://gyazo.com/9d55a55b93c00fdc488a23818af39b3a)  
- このように「Object的な」データと、「Relational」なデータは根本的にデータ構造が異なります。そのため、Java（Object指向）でRelationalなデータを扱おうとすると、どのクラスにどのデータを割り当る、という具合にデータをマッピングする必要が出てきます。このマッピングを簡単に行う仕組みをO/Rマッピングと言います。

### 3.2. JPAとHibernate
- Javaで公式に定められている、O/Rマッピングの「仕様」のことを「JPA（= Java Persistence API）」と呼びます。
- この「JPA」は単なる「仕様・規約」であり、その「仕様」を実装したソフトウェアが必要です。その一つが「Hibernate」というソフトウェアになります。

| 用語 | 説明 |
| --- | --- |
| JPA | 仕様・規約 |
| Hibernate | ソフトウェア |

### 3.3. Hibernateのセットアップ
- それではHibernateのセットアップに進みます。
- 手順：EclipseでJPAを使用するためにEclipseのプラグインを追加します。
  - Eclipseメニュー＞ヘルプ＞新規ソフトウェアのインストール　をクリック  
    - 作業対象：「2022-06 - https://download.eclipse.org/releases/2022-06/」をプルダウンより選択。
    - フィルター：JPA　を入力
    - 「Dali Java 永続化ツール - JPA サポート	3.6.1.v202204060305」にチェックを入れ、「完了」をクリック
    - インストールにしばらく時間がかかります。Eclipseの再起動を促すメッセージが表示されますので、再起動を実施します。
[![Image from Gyazo](https://i.gyazo.com/dbdf8f78561a9b79c23da3f56983aafb.png)](https://gyazo.com/dbdf8f78561a9b79c23da3f56983aafb)  

- 手順：JPAプロジェクトへ変換
  - 既にあるプロジェクトを「JPAプロジェクトへ変換」を行います。これによりプロジェクトでJPAの各種機能が利用可能になります。
  - 以下のようなウィザードが表示されます。デフォルト値でOKです。「次へ」をクリック。
[![Image from Gyazo](https://i.gyazo.com/72770bc30fd7103873eb42077c869593.png)](https://gyazo.com/72770bc30fd7103873eb42077c869593)  
  - 次画面で「JPA実装」＞「タイプ」を「ライブラリー構成を無効」をプルダウンより選択してください。（後で個別に設定するため）「完了」をクリックします。  
[![Image from Gyazo](https://i.gyazo.com/35ac07aeecb1c3efcf1a160687b7053d.png)](https://gyazo.com/35ac07aeecb1c3efcf1a160687b7053d)  
  - パッケージ・エクスプローラー上の以下に「persistence.xml」が作成されることを確認します。  
[![Image from Gyazo](https://i.gyazo.com/1af2d0264e9342d00f19cf5e42af6f6a.png)](https://gyazo.com/1af2d0264e9342d00f19cf5e42af6f6a)

- 手順：Persistence.xmlの設定  
  - 「persistence.xml」をダブルクリックで開きます。
  - 「ソース」タブを開き、以下のXMLをコピペ後、保存してください。

``` xml
<?xml version="1.0" encoding="UTF-8"?>
<persistence version="2.2" xmlns="http://xmlns.jcp.org/xml/ns/persistence" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/persistence http://xmlns.jcp.org/xml/ns/persistence/persistence_2_2.xsd">
	<persistence-unit name="ChatSpaceApp" transaction-type="RESOURCE_LOCAL">
		<provider>org.hibernate.jpa.HibernatePersistenceProvider</provider>
		<properties>
			<property name="javax.persistence.jdbc.driver" value="com.mysql.cj.jdbc.Driver"/>
			<property name="javax.persistence.jdbc.url" value="jdbc:mysql://localhost/chatspaceapp?useSSL=false&amp;allowPublicKeyRetrieval=true"/>
			<property name="javax.persistence.jdbc.user" value="chatspaceuser"/>
			<property name="hibernate.dialect" value="org.hibernate.dialect.MySQL8Dialect"/>
			<property name="hibernate.show_sql" value="true" />
			<property name="hibernate.format_sql" value="true" />
			<property name="javax.persistence.schema-generation.database.action" value="create"/>
			<property name="javax.persistence.jdbc.password" value="chatspaceuser"/>
		</properties>
	</persistence-unit>
</persistence>
```
  - 各項目の設定は以下の意味になります。
    - javax.persistence.jdbc.driver：使用するJDBCを指定
    - javax.persistence.jdbc.url：JDBC接続文字列を指定
    - javax.persistence.jdbc.user：DB接続ユーザを指定
    - hibernate.dialect：MySQLの構文をサポート
    - hibernate.show_sql：コンソールに生成SQLを表示
    - hibernate.format_sql：SQL表示をフォーマット
    - javax.persistence.schema-generation.database.action：テーブルが存在しない場合、自動生成
    - javax.persistence.jdbc.password：DB接続パスワードを指定

## 4. モデルクラス（DTO）の作成
### 4-1. モデルクラス（DTO）とは？
- それではモデルクラス（DTO＝Data Transfer Object）の作成をします。
- モデルクラスとはデータを保持するクラスのことで、データベースのテーブルと基本的に１：１に紐付いています。
- 今回は以下のモデルクラスを作成します。

| クラス名 | 用途 |
| -------| ---- |
| User | 掲示板Webアプリのユーザを管理するクラス |
| Topic | 掲示板Webアプリのトピックを管理するクラス |
| Comment | トピックに投稿されるコメントを管理するクラス |

### 4-2. Userクラスの作成
- 手順：プロジェクト右クリック＞新規＞その他＞クラスを選択します。
- 以下情報を入力し、「完了」をクリックします。
[![Image from Gyazo](https://i.gyazo.com/85508fc08aac3371cd262c73b6a01fc9.png)](https://gyazo.com/85508fc08aac3371cd262c73b6a01fc9)  
  - パッケージ：models
  - 名前：User

- 以下、コーディングしていきます。（コード内の説明コメントは省略してもOKです。）
> User.java
``` JAVA
package models;


import java.sql.Timestamp;
import javax.persistence.Column;
import javax.persistence.Entity;
import javax.persistence.GeneratedValue;
import javax.persistence.GenerationType;
import javax.persistence.Id;
import javax.persistence.Table;

// テーブル名を記載
@Table(name = "users")
// このクラスかHibernateで管理されるクラスであることを示す
@Entity
public class User {
  // 項目がID（＝テーブルの主キーであることを示す）
	@Id
  // テーブルのカラムであることを表す（name=***　がカラム名となる）
	@Column(name = "id")
  // 自動生成（auto increment）することを示す
	@GeneratedValue(strategy = GenerationType.IDENTITY)
  // 変数定義
	private Integer id;

  // nullable：NULL値不可（＝必須項目）であることを示す
	@Column(name = "name", nullable = false)
	private String name;
	
	@Column(name = "password", nullable = false)
    private String password;
	
  // 今回Web掲示板アプリでは使用しません
	@Column(name = "isAdmin", nullable = false)
    private Integer isAdmin;
	
	@Column(name = "createdAt", nullable = false)
	private Timestamp createdAt;

  // setter, getter（自動生成できるので手で書く必要はなし）
	public Integer getId() {
		return id;
	}

	public void setId(Integer id) {
		this.id = id;
	}

	public String getName() {
		return name;
	}

	public void setName(String name) {
		this.name = name;
	}

	public String getPassword() {
		return password;
	}

	public void setPassword(String password) {
		this.password = password;
	}

	public Integer getIsAdmin() {
		return isAdmin;
	}

	public void setIsAdmin(Integer isAdmin) {
		this.isAdmin = isAdmin;
	}

	public Timestamp getCreatedAt() {
		return createdAt;
	}

	public void setCreatedAt(Timestamp createdAt) {
		this.createdAt = createdAt;
	}
}
```
- getter/setterは自動生成できます。
- 手順：Eclipseの　ソース＞getterおよびsetterの生成　を開き、「全て選択」にチェックを入れ、「生成」をクリックします。  
[![Image from Gyazo](https://i.gyazo.com/9c1b8d82c20f454189f1a89b62665081.png)](https://gyazo.com/9c1b8d82c20f454189f1a89b62665081)  

### 4-３. Topicクラスの作成
- それでは同様に残りのモデルクラスも作成していきます。
- Userクラスで登場しなかった仕組みの部分のみ注釈（コメント）を入れています。

> Topic.java
``` JAVA
package models;

import java.sql.Timestamp;

import javax.persistence.Column;
import javax.persistence.Entity;
import javax.persistence.GeneratedValue;
import javax.persistence.GenerationType;
import javax.persistence.Id;
import javax.persistence.JoinColumn;
import javax.persistence.Lob;
import javax.persistence.ManyToOne;
import javax.persistence.Table;

@Table(name = "topics")
@Entity
public class Topic {
	@Id
	@Column(name = "id")
	@GeneratedValue(strategy = GenerationType.IDENTITY)
	private Integer id;

	@Column(name = "title", nullable = false)
	private String title;
	
  // LobはLarge Objectの略で比較的大きなデータを登録するためのものになります。
  // MySQLではデータ型「longtext」として生成されます。
	@Lob
	@Column(name = "description", nullable = false)
	private String description;

	@Column(name = "commentNum", nullable = false)
	private Integer commentNum;
	
	@Column(name = "createdAt", nullable = false)
	private Timestamp createdAt;
	
  // このカラムがUserクラスを外部参照していることを表す
  // ManyToOneは「ユーザ：トピック＝N：１」であることを表します。
  // データ型はUserクラスを指定します。
	@ManyToOne
	@JoinColumn(name = "user", nullable = false)
	private User user;

	public Integer getId() {
		return id;
	}

	public void setId(Integer id) {
		this.id = id;
	}

	public String getTitle() {
		return title;
	}

	public void setTitle(String title) {
		this.title = title;
	}

	public String getDescription() {
		return description;
	}

	public void setDescription(String description) {
		this.description = description;
	}

	public Integer getCommentNum() {
		return commentNum;
	}

	public void setCommentNum(Integer commentNum) {
		this.commentNum = commentNum;
	}

	public Timestamp getCreatedAt() {
		return createdAt;
	}

	public void setCreatedAt(Timestamp createdAt) {
		this.createdAt = createdAt;
	}

	public User getUser() {
		return user;
	}

	public void setUser(User user) {
		this.user = user;
	}
}
```

### 4-4. Commentクラスの作成
> Comment.java

``` JAVA
package models;

import java.sql.Timestamp;

import javax.persistence.Column;
import javax.persistence.Entity;
import javax.persistence.GeneratedValue;
import javax.persistence.GenerationType;
import javax.persistence.Id;
import javax.persistence.JoinColumn;
import javax.persistence.Lob;
import javax.persistence.ManyToOne;
import javax.persistence.Table;

@Table(name = "topics")
@Entity
public class Topic {
	@Id
	@Column(name = "id")
	@GeneratedValue(strategy = GenerationType.IDENTITY)
	private Integer id;

	@Column(name = "title", nullable = false)
	private String title;
	
	@Lob
	@Column(name = "description", nullable = false)
	private String description;

	@Column(name = "commentNum", nullable = false)
	private Integer commentNum;
	
	@Column(name = "createdAt", nullable = false)
	private Timestamp createdAt;
	
	@ManyToOne
	@JoinColumn(name = "user", nullable = false)
	private User user;

	public Integer getId() {
		return id;
	}

	public void setId(Integer id) {
		this.id = id;
	}

	public String getTitle() {
		return title;
	}

	public void setTitle(String title) {
		this.title = title;
	}

	public String getDescription() {
		return description;
	}

	public void setDescription(String description) {
		this.description = description;
	}

	public Integer getCommentNum() {
		return commentNum;
	}

	public void setCommentNum(Integer commentNum) {
		this.commentNum = commentNum;
	}

	public Timestamp getCreatedAt() {
		return createdAt;
	}

	public void setCreatedAt(Timestamp createdAt) {
		this.createdAt = createdAt;
	}

	public User getUser() {
		return user;
	}

	public void setUser(User user) {
		this.user = user;
	}
}
```

- 作成したモデルクラスをHibernateの管理クラスとして指定します。
- persistence.xmlの以下をコピペし、保存してください。

``` xml
<?xml version="1.0" encoding="UTF-8"?>
<persistence version="2.2" xmlns="http://xmlns.jcp.org/xml/ns/persistence" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/persistence http://xmlns.jcp.org/xml/ns/persistence/persistence_2_2.xsd">
	<persistence-unit name="ChatSpaceApp" transaction-type="RESOURCE_LOCAL">
		<provider>org.hibernate.jpa.HibernatePersistenceProvider</provider>
		<class>models.Topic</class>
		<class>models.Comment</class>
		<class>models.User</class>
		<properties>
			<property name="javax.persistence.jdbc.driver" value="com.mysql.cj.jdbc.Driver"/>
			<property name="javax.persistence.jdbc.url" value="jdbc:mysql://localhost/chatspaceapp?useSSL=false&amp;allowPublicKeyRetrieval=true"/>
			<property name="javax.persistence.jdbc.user" value="chatspaceuser"/>
			<property name="hibernate.dialect" value="org.hibernate.dialect.MySQL8Dialect"/>
			<property name="hibernate.show_sql" value="true" />
			<property name="hibernate.format_sql" value="true" />
			<property name="javax.persistence.schema-generation.database.action" value="create"/>
			<property name="javax.persistence.jdbc.password" value="chatspaceuser"/>
		</properties>
	</persistence-unit>
</persistence>
```

- 以下のような状態になっていればOKです。
[![Image from Gyazo](https://i.gyazo.com/a6af29ecd96924049d2d88654c584bf8.png)](https://gyazo.com/a6af29ecd96924049d2d88654c584bf8)  

## 5. DAOクラスの作成
- DAOクラス（DAO＝Data Access Object）の作成をします。
- DAOクラスとは名前の通り、データベースとの繋ぎ役となるクラスです。
- 手順：プロジェクト右クリック＞新規＞その他＞クラスを選択します。
- 以下情報を入力し、「完了」をクリックします。
[![Image from Gyazo](https://i.gyazo.com/b13463716913c099393733ed532cee78.png)](https://gyazo.com/b13463716913c099393733ed532cee78)  
  - パッケージ：utils
  - 名前：JPAUtil
- 以下、コーディングしていきます。（コード内の説明コメントは省略してもOKです。）

``` JAVA
package utils;

import javax.persistence.EntityManagerFactory;
import javax.persistence.Persistence;

public class JPAUtil {
	
	// PERSISTENCE_UNIT_NAMEにpersistence.xml＞一般タブ＞名前　で記載した
	// 名前を指定します。これにより、persistence.xml内の接続文字列等
	// DBへの接続情報、管理クラス等を取得します。
	private static final String PERSISTENCE_UNIT_NAME = "ChatSpaceApp";
	// EntityManagerFactoryがDBへの接続を管理するクラス（正確にはインターフェース）です。
	private static EntityManagerFactory factory;
	
	// 後ほどこのgetEntityManagerFactoryメソッドを使用して、
	// DBへの接続オブジェクトを各種ビジネスロジックのクラスより取得します。
	public static EntityManagerFactory getEntityManagerFactory() {
        if (factory == null) {
            factory = Persistence.createEntityManagerFactory(PERSISTENCE_UNIT_NAME);
        }
        return factory;
    }	
}
```

## 6. まとめ
- この章では各種ライブラリとMySQL関連のセットアップ及びDTO/DAOクラスの作成を行いました。
- 次章からいよいよメインのサーブレット/JSPの作成を行っていきます。
